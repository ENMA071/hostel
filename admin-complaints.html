<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Complaints - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4bb543;
            --warning-color: #f0ad4e;
            --danger-color: #d9534f;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-color);
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left h1 {
            color: white;
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left h1 i {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 50%;
        }

        .header-right {
            display: flex;
            gap: 15px;
        }

        .btn-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-back:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .admin-info {
            color: white;
            text-align: right;
        }

        .admin-info .admin-name {
            font-weight: 600;
            font-size: 16px;
        }

        .admin-info .admin-role {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .filter-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
        }

        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filter-header h2 {
            color: var(--primary-color);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(67, 97, 238, 0.3);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--dark-color);
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            background-color: #f8f9fa;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: white;
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
        }

        .complaints-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .complaints-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .complaints-header h3 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .complaints-container {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .complaint-item {
            background: #f8f9fa;
            border: 2px solid #e1e8ed;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            transition: var(--transition);
            position: relative;
        }

        .complaint-item:hover {
            border-color: var(--accent-color);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .complaint-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .complaint-left {
            flex: 1;
            min-width: 300px;
        }

        .complaint-id {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .complaint-title {
            font-weight: 700;
            color: var(--dark-color);
            font-size: 18px;
            margin-bottom: 10px;
        }

        .complaint-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-item i {
            color: var(--accent-color);
            width: 16px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-resolved {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #4bb543;
        }

        .status-inprogress {
            background-color: #cce5ff;
            color: #004085;
            border: 1px solid #4895ef;
        }

        .status-closed {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #d9534f;
        }

        .complaint-description {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--accent-color);
            margin: 15px 0;
            color: #495057;
            line-height: 1.6;
        }

        .complaint-images {
            margin: 15px 0;
        }

        .complaint-images h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .complaint-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .complaint-image-thumb {
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .complaint-image-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .complaint-image-thumb img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .complaint-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            text-decoration: none;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #3fa237 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 181, 67, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ec971f 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(240, 173, 78, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #c9302c 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 83, 79, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
        }

        .btn:disabled {
            background: #6c757d !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #dee2e6;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 16px;
            line-height: 1.5;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 500px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 22px;
        }

        .modal p {
            color: #6c757d;
            margin-bottom: 25px;
            line-height: 1.5;
            font-size: 16px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 30px;
            right: 50px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            transition: var(--transition);
            z-index: 1002;
        }

        .image-modal-close:hover {
            color: var(--accent-color);
            transform: scale(1.2);
        }

        .permission-request {
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border: 2px solid #ffc107;
            border-radius: var(--border-radius);
            padding: 15px;
            margin: 15px 0;
        }

        .permission-request h4 {
            color: #f57f17;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .permission-request p {
            color: #bf360c;
            font-size: 14px;
        }

        .priority-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .priority-high {
            background: var(--danger-color);
        }

        .priority-medium {
            background: var(--warning-color);
        }

        .priority-low {
            background: var(--success-color);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-left h1 {
                font-size: 22px;
            }

            .filters-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .complaint-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .complaint-actions {
                flex-direction: column;
            }

            .modal {
                width: 95%;
                padding: 20px;
            }

            .modal-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <h1>
                    <i class="fas fa-clipboard-list"></i>
                    Complaints Management
                </h1>
            </div>
            <div class="header-right">
                <a href="admin-index.html" class="btn-back">
                    <i class="fas fa-arrow-left"></i>
                    Back to Dashboard
                </a>
                <div class="admin-info">
                    <div class="admin-name" id="adminName">Administrator</div>
                    <div class="admin-role" id="adminRole">Super Admin</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-header">
                <h2>
                    <i class="fas fa-filter"></i>
                    Filter & Statistics
                </h2>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-number" id="totalComplaints">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingComplaints">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inProgressComplaints">0</div>
                    <div class="stat-label">In Progress</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="resolvedComplaints">0</div>
                    <div class="stat-label">Resolved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="closedComplaints">0</div>
                    <div class="stat-label">Closed</div>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="filters-row">
                <div class="filter-group">
                    <label for="statusFilter">Filter by Status</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="inprogress">In Progress</option>
                        <option value="resolved">Resolved</option>
                        <option value="closed">Closed</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="typeFilter">Filter by Type</label>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="security">Electrical</option>
                        <option value="cleanliness">Cleanliness</option>
                        <option value="facility">Internet & Wi-Fi</option>
                        <option value="food">Mess/Food Quality</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="roomFilter">Filter by Room</label>
                    <input type="text" id="roomFilter" placeholder="Enter room number">
                </div>
                <div class="filter-group">
                    <label for="dateFilter">Filter by Date</label>
                    <input type="date" id="dateFilter">
                </div>
            </div>
        </div>

        <!-- Complaints Section -->
        <div class="complaints-section">
            <div class="complaints-header">
                <h3>
                    <i class="fas fa-exclamation-circle"></i>
                    All Complaints
                </h3>
                <div id="resultCount">Loading...</div>
            </div>
            <div class="complaints-container" id="complaintsContainer">
                <!-- Complaints will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Approve/Progress Modal -->
    <div id="approveModal" class="modal-overlay">
        <div class="modal">
            <h3>
                <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                Update Complaint Status
            </h3>
            <p id="approveModalText">Move this complaint to "In Progress" status?</p>
            <div class="modal-actions">
                <button class="btn btn-success" onclick="confirmStatusUpdate()">
                    <i class="fas fa-check"></i> Confirm
                </button>
                <button class="btn btn-danger" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Close Complaint Modal -->
    <div id="closeModal" class="modal-overlay">
        <div class="modal">
            <h3>
                <i class="fas fa-times-circle" style="color: var(--warning-color);"></i>
                Request Closure Permission
            </h3>
            <p>Send a closure request to the student? They will be asked to confirm if the issue is fully resolved.</p>
            <div class="modal-actions">
                <button class="btn btn-warning" onclick="confirmClosureRequest()">
                    <i class="fas fa-paper-plane"></i> Send Request
                </button>
                <button class="btn btn-danger" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal">
            <h3>
                <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                Confirm Delete
            </h3>
            <p>Are you sure you want to delete this complaint? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn btn-primary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" src="" alt="Complaint Image">
    </div>

    <script>
        // Global variables
        let currentComplaintId = null;
        let currentAction = null;
        let allComplaints = [];

        // Load admin info and initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadAdminInfo();
            loadComplaints();
            setupEventListeners();
        });

        function loadAdminInfo() {
            const loggedInUser = sessionStorage.getItem('loggedInUser');
            if (loggedInUser) {
                const user = JSON.parse(loggedInUser);
                document.getElementById('adminName').textContent = user.name || 'Administrator';
                document.getElementById('adminRole').textContent = user.role || 'Super Admin';
            }
        }

        function setupEventListeners() {
            document.getElementById('statusFilter').addEventListener('change', filterComplaints);
            document.getElementById('typeFilter').addEventListener('change', filterComplaints);
            document.getElementById('roomFilter').addEventListener('input', filterComplaints);
            document.getElementById('dateFilter').addEventListener('change', filterComplaints);
        }

        // Load and display complaints
        function loadComplaints() {
            // Get complaints from localStorage (in real app, this would be from API)
            let complaints = JSON.parse(localStorage.getItem('complaints') || '[]');
            
            // Add some demo complaints with different statuses for testing
            if (complaints.length === 0) {
                complaints = [
                    {
                        id: '1703123456789',
                        studentName: 'Ankit Gurjar',
                        roomNumber: 'A-101',
                        complaintType: 'security',
                        description: 'The air conditioning in my room has been making loud noises for the past week. It also doesn\'t cool the room properly, making it difficult to study and sleep.',
                        images: [],
                        status: 'pending',
                        timestamp: new Date(Date.now() - 86400000).toISOString(),
                        priority: 'high'
                    },
                    {
                        id: '1703123456790',
                        studentName: 'Shivam Bansal',
                        roomNumber: 'A-101',
                        complaintType: 'cleanliness',
                        description: 'The common washroom on the second floor has not been cleaned properly for several days. There are hygiene concerns.',
                        images: [],
                        status: 'inprogress',
                        timestamp: new Date(Date.now() - 172800000).toISOString(),
                        priority: 'medium'
                    },
                    {
                        id: '1703123456791',
                        studentName: 'Sahitya Patel',
                        roomNumber: 'A-101',
                        complaintType: 'food',
                        description: 'The food quality in the mess has been consistently poor. Vegetables are not fresh and rice is often undercooked.',
                        images: [],
                        status: 'resolved',
                        timestamp: new Date(Date.now() - 432000000).toISOString(),
                        priority: 'medium',
                        permissionRequested: true
                    },
                    {
                        id: '1703123456792',
                        studentName: 'Anshul Suryavanshi',
                        roomNumber: 'A-102',
                        complaintType: 'facility',
                        description: 'Wi-Fi connection is very slow and frequently disconnects in the hostel. This affects online classes and studies.',
                        images: [],
                        status: 'pending',
                        timestamp: new Date(Date.now() - 259200000).toISOString(),
                        priority: 'high'
                    },
                    {
                        id: '1703123456793',
                        studentName: 'Amit Singh',
                        roomNumber: 'A-103',
                        complaintType: 'other',
                        description: 'There is a water leakage in the corridor near room A-103. The floor is always wet and slippery.',
                        images: [],
                        status: 'closed',
                        timestamp: new Date(Date.now() - 604800000).toISOString(),
                        priority: 'low'
                    }
                ];
                localStorage.setItem('complaints', JSON.stringify(complaints));
            }

            allComplaints = complaints;
            filterComplaints();
            updateStatistics();
        }

        function updateStatistics() {
            const stats = {
                total: allComplaints.length,
                pending: allComplaints.filter(c => c.status === 'pending').length,
                inprogress: allComplaints.filter(c => c.status === 'inprogress').length,
                resolved: allComplaints.filter(c => c.status === 'resolved').length,
                closed: allComplaints.filter(c => c.status === 'closed').length
            };

            document.getElementById('totalComplaints').textContent = stats.total;
            document.getElementById('pendingComplaints').textContent = stats.pending;
            document.getElementById('inProgressComplaints').textContent = stats.inprogress;
            document.getElementById('resolvedComplaints').textContent = stats.resolved;
            document.getElementById('closedComplaints').textContent = stats.closed;
        }

        function filterComplaints() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const roomFilter = document.getElementById('roomFilter').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;

            let filteredComplaints = allComplaints;

            if (statusFilter) {
                filteredComplaints = filteredComplaints.filter(c => c.status === statusFilter);
            }

            if (typeFilter) {
                filteredComplaints = filteredComplaints.filter(c => c.complaintType === typeFilter);
            }

            if (roomFilter) {
                filteredComplaints = filteredComplaints.filter(c => 
                    c.roomNumber.toLowerCase().includes(roomFilter) ||
                    c.studentName.toLowerCase().includes(roomFilter)
                );
            }

            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                filteredComplaints = filteredComplaints.filter(c => {
                    const complaintDate = new Date(c.timestamp);
                    return complaintDate.toDateString() === filterDate.toDateString();
                });
            }

            displayComplaints(filteredComplaints);
            document.getElementById('resultCount').textContent = `${filteredComplaints.length} complaint(s) found`;
        }

        function displayComplaints(complaints) {
            const container = document.getElementById('complaintsContainer');

            if (complaints.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No complaints found</h3>
                        <p>No complaints match your current filters or there are no complaints in the system.</p>
                    </div>
                `;
                return;
            }

            // Sort by timestamp (newest first), then by priority
            complaints.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                if (a.priority !== b.priority) {
                    return (priorityOrder[b.priority] || 1) - (priorityOrder[a.priority] || 1);
                }
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            container.innerHTML = complaints.map(complaint => {
                const date = new Date(complaint.timestamp).toLocaleDateString();
                const time = new Date(complaint.timestamp).toLocaleTimeString();
                
                const typeLabels = {
                    security: 'Electrical',
                    cleanliness: 'Cleanliness',
                    facility: 'Internet & Wi-Fi',
                    food: 'Mess/Food Quality',
                    other: 'Other'
                };

                // Determine available actions based on status
                let actionButtons = '';
                if (complaint.status === 'pending') {
                    actionButtons = `
                        <button class="btn btn-success" onclick="showStatusModal('${complaint.id}', 'approve')">
                            <i class="fas fa-check"></i> Approve & Start Work
                        </button>
                        <button class="btn btn-danger" onclick="showDeleteModal('${complaint.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (complaint.status === 'inprogress') {
                    actionButtons = `
                        <button class="btn btn-success" onclick="showStatusModal('${complaint.id}', 'resolve')">
                            <i class="fas fa-check-double"></i> Mark as Resolved
                        </button>
                        <button class="btn btn-danger" onclick="showDeleteModal('${complaint.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                } else if (complaint.status === 'resolved') {
                    if (complaint.permissionRequested) {
                        actionButtons = `
                            <button class="btn btn-warning" disabled>
                                <i class="fas fa-clock"></i> Awaiting Student Response
                            </button>
                            <button class="btn btn-danger" onclick="showDeleteModal('${complaint.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        `;
                    } else {
                        actionButtons = `
                            <button class="btn btn-warning" onclick="showCloseModal('${complaint.id}')">
                                <i class="fas fa-paper-plane"></i> Request Closure
                            </button>
                            <button class="btn btn-danger" onclick="showDeleteModal('${complaint.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        `;
                    }
                } else if (complaint.status === 'closed') {
                    actionButtons = `
                        <button class="btn btn-primary" onclick="showStatusModal('${complaint.id}', 'reopen')">
                            <i class="fas fa-redo"></i> Reopen
                        </button>
                        <button class="btn btn-danger" onclick="showDeleteModal('${complaint.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                }

                // Display images if available
                let imagesHtml = '';
                if (complaint.images && complaint.images.length > 0) {
                    imagesHtml = `
                        <div class="complaint-images">
                            <h4><i class="fas fa-images"></i> Attachments (${complaint.images.length})</h4>
                            <div class="complaint-image-grid">
                                ${complaint.images.map(img => `
                                    <div class="complaint-image-thumb" onclick="showImageModal('${img.data}')">
                                        <img src="${img.data}" alt="${img.name}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // Permission request notification
                let permissionHtml = '';
                if (complaint.status === 'resolved' && complaint.permissionRequested) {
                    permissionHtml = `
                        <div class="permission-request">
                            <h4><i class="fas fa-hourglass-half"></i> Closure Request Sent</h4>
                            <p>Waiting for ${complaint.studentName} to confirm that the issue has been resolved satisfactorily.</p>
                        </div>
                    `;
                }

                return `
                    <div class="complaint-item">
                        <div class="priority-indicator priority-${complaint.priority || 'medium'}"></div>
                        
                        <div class="complaint-header">
                            <div class="complaint-left">
                                <div class="complaint-id">ID: ${complaint.id}</div>
                                <div class="complaint-title">${typeLabels[complaint.complaintType] || complaint.complaintType} - ${complaint.studentName}</div>
                                
                                <div class="complaint-meta">
                                    <div class="meta-item">
                                        <i class="fas fa-user"></i>
                                        <span>${complaint.studentName}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-door-open"></i>
                                        <span>Room ${complaint.roomNumber}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-calendar"></i>
                                        <span>${date}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>${time}</span>
                                    </div>
                                    <div class="meta-item">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>${(complaint.priority || 'medium').charAt(0).toUpperCase() + (complaint.priority || 'medium').slice(1)} Priority</span>
                                    </div>
                                </div>
                            </div>
                            
                            <span class="status-badge status-${complaint.status}">
                                <i class="fas fa-circle"></i>
                                ${complaint.status.charAt(0).toUpperCase() + complaint.status.slice(1)}
                            </span>
                        </div>
                        
                        <div class="complaint-description">
                            <strong>Issue Description:</strong><br>
                            ${complaint.description}
                        </div>
                        
                        ${imagesHtml}
                        ${permissionHtml}
                        
                        <div class="complaint-actions">
                            ${actionButtons}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal functions
        function showStatusModal(complaintId, action) {
            currentComplaintId = complaintId;
            currentAction = action;
            
            const modal = document.getElementById('approveModal');
            const modalText = document.getElementById('approveModalText');
            
            switch (action) {
                case 'approve':
                    modalText.textContent = 'Approve this complaint and move it to "In Progress" status?';
                    break;
                case 'resolve':
                    modalText.textContent = 'Mark this complaint as "Resolved"? You can then request student confirmation to close it.';
                    break;
                case 'reopen':
                    modalText.textContent = 'Reopen this complaint and move it back to "In Progress" status?';
                    break;
            }
            
            modal.style.display = 'flex';
        }

        function showCloseModal(complaintId) {
            currentComplaintId = complaintId;
            document.getElementById('closeModal').style.display = 'flex';
        }

        function showDeleteModal(complaintId) {
            currentComplaintId = complaintId;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('approveModal').style.display = 'none';
            document.getElementById('closeModal').style.display = 'none';
            document.getElementById('deleteModal').style.display = 'none';
            currentComplaintId = null;
            currentAction = null;
        }

        function confirmStatusUpdate() {
            if (currentComplaintId && currentAction) {
                let complaints = JSON.parse(localStorage.getItem('complaints') || '[]');
                const complaintIndex = complaints.findIndex(c => c.id === currentComplaintId);
                
                if (complaintIndex !== -1) {
                    switch (currentAction) {
                        case 'approve':
                            complaints[complaintIndex].status = 'inprogress';
                            showNotification('Complaint approved and moved to In Progress!', 'success');
                            break;
                        case 'resolve':
                            complaints[complaintIndex].status = 'resolved';
                            complaints[complaintIndex].resolvedDate = new Date().toISOString();
                            showNotification('Complaint marked as resolved! You can now request closure confirmation.', 'success');
                            break;
                        case 'reopen':
                            complaints[complaintIndex].status = 'inprogress';
                            complaints[complaintIndex].permissionRequested = false;
                            showNotification('Complaint reopened and moved to In Progress!', 'success');
                            break;
                    }
                    
                    localStorage.setItem('complaints', JSON.stringify(complaints));
                    allComplaints = complaints;
                    filterComplaints();
                    updateStatistics();
                }
                closeModal();
            }
        }

        function confirmClosureRequest() {
            if (currentComplaintId) {
                let complaints = JSON.parse(localStorage.getItem('complaints') || '[]');
                const complaintIndex = complaints.findIndex(c => c.id === currentComplaintId);
                
                if (complaintIndex !== -1) {
                    complaints[complaintIndex].permissionRequested = true;
                    complaints[complaintIndex].permissionRequestDate = new Date().toISOString();
                    
                    localStorage.setItem('complaints', JSON.stringify(complaints));
                    allComplaints = complaints;
                    filterComplaints();
                    
                    showNotification('Closure request sent to student! They will be notified to confirm resolution.', 'success');
                }
                closeModal();
            }
        }

        function confirmDelete() {
            if (currentComplaintId) {
                let complaints = JSON.parse(localStorage.getItem('complaints') || '[]');
                complaints = complaints.filter(c => c.id !== currentComplaintId);
                
                localStorage.setItem('complaints', JSON.stringify(complaints));
                allComplaints = complaints;
                filterComplaints();
                updateStatistics();
                
                showNotification('Complaint deleted successfully!', 'success');
                closeModal();
            }
        }

        // Image modal functions
        function showImageModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('imageModal').style.display = 'flex';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};
                color: white;
                padding: 15px 20px;
                border-radius: var(--border-radius);
                box-shadow: var(--box-shadow);
                z-index: 9999;
                min-width: 300px;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideInRight 0.3s ease;
            `;
            
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                closeImageModal();
            }
        });

        // Add CSS animation for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>